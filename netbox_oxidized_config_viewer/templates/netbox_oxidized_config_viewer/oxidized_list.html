{% extends 'base/layout.html' %}
{% load i18n %}
{% load render_table from django_tables2 %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5>{% trans "Oxidized Device List" %}</h5>
    </div>
    <div class="card-body">
        {% render_table table %}
    </div>
    <div class="card-footer text-muted">
        <small>{% trans "Oxidized Backup:" %} {{ table.data|length }} {% trans "devices" %}</small>
    </div>
</div>

<!-- Backup table template -->
<!-- No longer need a template, the HTML will be fetched directly -->

<!-- CSS for skeleton loader -->
<style>
    .skeleton {
        animation: skeleton-loading 1s linear infinite alternate;
    }

    @keyframes skeleton-loading {
        0% {
            background-color: hsl(200, 20%, 80%);
        }
        100% {
            background-color: hsl(200, 20%, 95%);
        }
    }

    .skeleton-table .skeleton-row {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        border-bottom: 1px solid #eee;
    }

    .skeleton-table .skeleton-cell {
        height: 20px;
        flex-basis: 30%;
        border-radius: 4px;
    }
</style>

<!-- JavaScript for handling backup display -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded and parsed');

        // Handle click on expand/collapse icon
        document.body.addEventListener('click', function(event) {
            console.log('Click event detected on body');

            if (event.target) {
                console.log(`Click target:`, event.target);
                console.log(`Click target classes:`, event.target.classList);

                // Check if target or any of its ancestors has the show-backups class
                let targetElement = event.target;
                let hasShowBackupsClass = false;
                let parentElement = targetElement;

                // Find element with show-backups class
                while (parentElement) {
                    if (parentElement.classList.contains('show-backups')) {
                        hasShowBackupsClass = true;
                        targetElement = parentElement;
                        break;
                    }
                    parentElement = parentElement.parentElement;
                }

                if (hasShowBackupsClass) {
                    console.log('Element with show-backups class found');
                    event.preventDefault();

                    // Get the device name from data attribute
                    const deviceName = targetElement.getAttribute('data-device-name');
                    console.log(`Device name attribute: ${deviceName}`);

                    if (!deviceName) {
                        console.warn('Device name attribute is missing or empty');
                        // Try to find the attribute on parent elements
                        let parent = event.target.parentElement;
                        while (parent && !deviceName) {
                            deviceName = parent.getAttribute('data-device-name');
                            if (deviceName) {
                                console.log(`Found device name on parent element: ${deviceName}`);
                            }
                            parent = parent.parentElement;
                        }
                    }

                    console.log(`Device clicked: ${deviceName || 'unknown'}`);

                    // Find the row this icon is in
                    const row = event.target.closest('tr');

                    // Check if backup table already exists for this row
                    let backupRow = row.nextElementSibling;
                    if (backupRow && backupRow.classList.contains('backup-row')) {
                        // If the backup row already exists, toggle its visibility
                        if (backupRow.style.display === 'none') {
                            backupRow.style.display = 'table-row';
                            targetElement.querySelector('i').classList.replace('mdi-chevron-right', 'mdi-chevron-down');
                        } else {
                            backupRow.style.display = 'none';
                            targetElement.querySelector('i').classList.replace('mdi-chevron-down', 'mdi-chevron-right');
                        }
                        return;
                    }

                    // Change icon to down arrow
                    targetElement.querySelector('i').classList.replace('mdi-chevron-right', 'mdi-chevron-down');

                    // Create a new row for the backup table
                    const newRow = document.createElement('tr');
                    newRow.className = 'backup-row';
                    const cell = newRow.insertCell();
                    cell.colSpan = row.cells.length;
                    
                    // Add skeleton loader
                    const skeletonHtml = `
                        <div class="card">
                            <div class="card-body skeleton-table">
                                <div class="skeleton-row">
                                    <div class="skeleton skeleton-cell"></div>
                                    <div class="skeleton skeleton-cell"></div>
                                    <div class="skeleton skeleton-cell"></div>
                                </div>
                                <div class="skeleton-row">
                                    <div class="skeleton skeleton-cell"></div>
                                    <div class="skeleton skeleton-cell"></div>
                                    <div class="skeleton skeleton-cell"></div>
                                </div>
                                <div class="skeleton-row">
                                    <div class="skeleton skeleton-cell"></div>
                                    <div class="skeleton skeleton-cell"></div>
                                    <div class="skeleton skeleton-cell"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    cell.innerHTML = skeletonHtml;
                    row.parentNode.insertBefore(newRow, row.nextSibling);

                    // Fetch backup data from server API
                    console.log(`Fetching backup data for ${deviceName}`);
                    fetch(`/plugins/netbox_oxidized_config_viewer/api/backup-detail/${encodeURIComponent(deviceName)}/`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.text();
                        })
                        .then(html => {
                            cell.innerHTML = html;
                        })
                        .catch(error => {
                            console.error('Error fetching backups:', error);
                            cell.innerHTML = '<tr><td colspan="3">Error loading backups.</td></tr>';
                        });
                }
            }
        });
    });
</script>
{% endblock %}